name: "Build mocaccino micro iso"
image: sabayon/ci
type: lxd
queue: lxd
directory: "/"
storage: 'mocaccino-credentials'
source: https://github.com/mocaccinoOS/mocaccino-desktop
environment:
- IMAGE_NAME=MocaccinoOS-Micro
- OVERLAY=true 
- FIRST_STAGE=distro/mocaccino-initramfs
- ISOIMAGE_PACKAGES=live/syslinux system/mocaccino-live-boot
- UEFI_PACKAGES=live/systemd-boot system/mocaccino-live-boot
- LUET_PACKAGES=utils/busybox utils/busybox-init repository/mocaccino-extra system/mocaccino-init kernel/sabayon-full system/mocaccino-live-boot system/luet system/container-diff
- LUET_GENERAL__DEBUG=true

script:
- IMAGE_NAME=$IMAGE_NAME-0.$(date +%Y%m%d).iso
- sleep 5
- systemctl start docker
- source storage/env
- git clone https://github.com/mocaccinoOS/desktop mocaccino-desktop
- cd mocaccino-desktop
- curl https://gist.githubusercontent.com/mudler/8b8d6c53c4669f4b9f9a72d1a2b92172/raw/114dcc00bad41896f8614cc0214f834b95a1e2a6/get_luet_root.sh | sudo sh
- sudo luet install system/container-diff system/luet-extensions
- equo up && equo i sys-fs/squashfs-tools sys-fs/dosfstools dev-libs/libisoburn
- curl https://gist.githubusercontent.com/mudler/87a5da08bacae8ea69b8f15497534d8d/raw/26109389ea6eb5f0b8b54c9711509e5ec974b1d2/keybase_cp.sh > keybase_cp.sh
- ROOT_DIR=$PWD LUET_CONFIG="$PWD/conf/luet-micro.yaml" make iso
- sha256sum $IMAGE_NAME > $IMAGE_NAME.sha256
- mkdir isobuild
- mv $IMAGE_NAME $IMAGE_NAME.sha256 isobuild/
- bash keybase_cp.sh $PWD/isobuild /keybase/public/mocaccino/iso/micro

planned: "@daily"
