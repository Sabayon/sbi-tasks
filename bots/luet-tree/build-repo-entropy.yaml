name: "Build entropy luet tree"
image: sabayon/ci
type: docker
directory: "/bots/luet-tree"

script:
- equo up && ACCEPT_LICENSE=* equo i runc
- curl -fSL "https://github.com/genuinetools/img/releases/download/v0.5.7/img-linux-amd64" -o /usr/bin/img
- chmod +x /usr/bin/img
- export WORKDIR=$PWD
- curl -LO https://storage.googleapis.com/container-diff/latest/container-diff-linux-amd64 && chmod +x container-diff-linux-amd64 && mkdir -p $HOME/bin && sudo mv container-diff-linux-amd64 /usr/bin/container-diff
- git clone https://github.com/mudler/luet /luet
- pushd /luet
- go build
- mv luet /usr/bin/luet
- popd
- git clone --recurse-submodules https://github.com/luet-lab/sabayon-entropy-tree /tree
# Update user fork      
- pushd /tree
- mkdir build
# Compile repo targets
- make build
- mv build/* $WORKDIR/artefacts
- pushd $WORKDIR/artefacts
- rm -rfv *.image.tar build
- luet create-repo --name "Entropy Luet tree" --tree /tree --type "http"
tag_namespace: "luet-entropy-tree"
planned: "@daily"
