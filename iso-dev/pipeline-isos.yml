# Authors: Sabayon Team
#          geaaru@sabayonlinux.org
#          mudler@sabayonlinux.org)

# Note: Molecules use /dev/loopX device for mount .ISO file so we
#       need from host device access to loop controller and a free
#       loop device

pipeline_name: "Sabayon ISO Dev Build Pipeline"

concurrency: 1 # Number of parallel builds
group:
  - "gnome"
  - "kde"
  - "mate"
  - "xfce"
  - "minimal"
  - "server"
  - "lxqt"

# Temporary use only farmer node that support dynamic loop on container
queue: "iso"

tasks:

  # Sabayon GNOME ISO
  gnome:
    image: geaaru/isobuilder-amd64
    script:
      - /usr/bin/tini -s -- /sabayon-stuff/sabayon_molecules.sh run daily --image gnome --skip-docker-rmi --only-dev
    task: docker_execute
    storage: "8925468933589065900"
    artefact_path: namespace
    binds:
      - /dev/loop-control:/dev/loop-control
      - /tmp:/run
    directory: /
    environment:
      - SABAYON_MOLECULES_GITURL=https://github.com/Sabayon/molecules.git
      - SABAYON_MOLECULES_SYSTEMD_SLEEP=20
      - SABAYON_MOLECULES_SYSTEMD_MODE=0
      - SABAYON_MOLECULES_SCRIPT=/sabayon/scripts/sabayon_iso_build.sh
      - SABAYON_USE_IMG=0
    namespace: spinbase:iso-dev
    publish_mode: append
    storage: "8925468933589065900"
    storage_path: /confs
    tag_namespace: sabayon:iso
    timeout: 0

  # Sabayon KDE ISO
  kde:
    image: geaaru/isobuilder-amd64
    script:
      - /usr/bin/tini -s -- /sabayon-stuff/sabayon_molecules.sh run daily --image kde --skip-docker-rmi --only-dev
    task: docker_execute
    storage: "8925468933589065900"
    artefact_path: namespace
    binds:
      - /dev/loop-control:/dev/loop-control
      - /tmp:/run
    directory: /
    environment:
      - SABAYON_MOLECULES_GITURL=https://github.com/Sabayon/molecules.git
      - SABAYON_MOLECULES_SYSTEMD_SLEEP=20
      - SABAYON_MOLECULES_SYSTEMD_MODE=0
      - SABAYON_MOLECULES_SCRIPT=/sabayon/scripts/sabayon_iso_build.sh
      - SABAYON_USE_IMG=0
    namespace: spinbase:iso-dev
    publish_mode: append
    storage: "8925468933589065900"
    storage_path: /confs
    tag_namespace: sabayon:iso
    timeout: 0

  # Sabayon MATE ISO
  mate:
    image: geaaru/isobuilder-amd64
    script:
      - /usr/bin/tini -s -- /sabayon-stuff/sabayon_molecules.sh run daily --image mate --skip-docker-rmi --only-dev
    task: docker_execute
    storage: "8925468933589065900"
    artefact_path: namespace
    binds:
      - /dev/loop-control:/dev/loop-control
      - /tmp:/run
    directory: /
    environment:
      - SABAYON_MOLECULES_GITURL=https://github.com/Sabayon/molecules.git
      - SABAYON_MOLECULES_SYSTEMD_SLEEP=20
      - SABAYON_MOLECULES_SYSTEMD_MODE=0
      - SABAYON_MOLECULES_SCRIPT=/sabayon/scripts/sabayon_iso_build.sh
      - SABAYON_USE_IMG=0
    namespace: spinbase:iso-dev
    publish_mode: append
    storage: "8925468933589065900"
    storage_path: /confs
    tag_namespace: sabayon:iso
    timeout: 0

  # Sabayon Xfce ISO
  xfce:
    image: geaaru/isobuilder-amd64
    script:
      - /usr/bin/tini -s -- /sabayon-stuff/sabayon_molecules.sh run daily --image xfce --skip-docker-rmi --only-dev
    task: docker_execute
    storage: "8925468933589065900"
    artefact_path: namespace
    binds:
      - /dev/loop-control:/dev/loop-control
      - /tmp:/run
    directory: /
    environment:
      - SABAYON_MOLECULES_GITURL=https://github.com/Sabayon/molecules.git
      - SABAYON_MOLECULES_SYSTEMD_SLEEP=20
      - SABAYON_MOLECULES_SYSTEMD_MODE=0
      - SABAYON_MOLECULES_SCRIPT=/sabayon/scripts/sabayon_iso_build.sh
      - SABAYON_USE_IMG=0
    namespace: spinbase:iso-dev
    publish_mode: append
    storage: "8925468933589065900"
    storage_path: /confs
    tag_namespace: sabayon:iso
    timeout: 0

  # Sabayon Minimal ISO
  minimal:
    image: geaaru/isobuilder-amd64
    script:
      - /usr/bin/tini -s -- /sabayon-stuff/sabayon_molecules.sh run daily --image minimal --skip-docker-rmi --only-dev
    task: docker_execute
    storage: "8925468933589065900"
    artefact_path: namespace
    binds:
      - /dev/loop-control:/dev/loop-control
      - /tmp:/run
    directory: /
    environment:
      - SABAYON_MOLECULES_GITURL=https://github.com/Sabayon/molecules.git
      - SABAYON_MOLECULES_SYSTEMD_SLEEP=20
      - SABAYON_MOLECULES_SYSTEMD_MODE=0
      - SABAYON_MOLECULES_SCRIPT=/sabayon/scripts/sabayon_iso_build.sh
      - SABAYON_USE_IMG=0
    namespace: spinbase:iso-dev
    publish_mode: append
    storage: "8925468933589065900"
    storage_path: /confs
    tag_namespace: sabayon:iso
    timeout: 0

  # Sabayon Server ISO
  server:
    image: geaaru/isobuilder-amd64
    script:
      - /usr/bin/tini -s -- /sabayon-stuff/sabayon_molecules.sh run daily --image server --skip-docker-rmi --only-dev
    task: docker_execute
    storage: "8925468933589065900"
    artefact_path: namespace
    binds:
      - /dev/loop-control:/dev/loop-control
      - /tmp:/run
    directory: /
    environment:
      - SABAYON_MOLECULES_GITURL=https://github.com/Sabayon/molecules.git
      - SABAYON_MOLECULES_SYSTEMD_SLEEP=20
      - SABAYON_MOLECULES_SYSTEMD_MODE=0
      - SABAYON_MOLECULES_SCRIPT=/sabayon/scripts/sabayon_iso_build.sh
      - SABAYON_USE_IMG=0
    namespace: spinbase:iso-dev
    publish_mode: append
    storage: "8925468933589065900"
    storage_path: /confs
    tag_namespace: sabayon:iso
    timeout: 0

  # Sabayon Lxqt ISO
  lxqt:
    image: geaaru/isobuilder-amd64
    script:
      - /usr/bin/tini -s -- /sabayon-stuff/sabayon_molecules.sh run daily --image lxqt --skip-docker-rmi --only-dev
    task: docker_execute
    storage: "8925468933589065900"
    artefact_path: namespace
    binds:
      - /dev/loop-control:/dev/loop-control
      - /tmp:/run
    directory: /
    environment:
      - SABAYON_MOLECULES_GITURL=https://github.com/Sabayon/molecules.git
      - SABAYON_MOLECULES_SYSTEMD_SLEEP=20
      - SABAYON_MOLECULES_SYSTEMD_MODE=0
      - SABAYON_MOLECULES_SCRIPT=/sabayon/scripts/sabayon_iso_build.sh
      - SABAYON_USE_IMG=0
    namespace: spinbase:iso-dev
    publish_mode: append
    storage: "8925468933589065900"
    storage_path: /confs
    tag_namespace: sabayon:iso
    timeout: 0

